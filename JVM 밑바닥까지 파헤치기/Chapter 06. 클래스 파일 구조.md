# Chapter 06. 클래스 파일 구조

## 6.2 플랫폼 독립을 향한 초석

- 언어 독립성을 보장하는 핵심은 가상 머신과 바이트코드 저장 형식이다.
- 자바 가상 머신은 자바를 포함하여 어떠한 프로그래밍 언어에도 종속되지 않는다. 클래스 파일이라는 특정한 바이너리 파일 형식에만 의존할 뿐이다.

- 클래스 파일에는 자바 가상 머신 명령어 집합과 심벌 테이블 그리고 몇 가지 추가 정보가 담긴다.
- 가상 머신 자체는 클래스의 원래 소스 코드가 어떤 언어인지 상관하지 않는다.

## 6.3 클래스 파일의 구조

- 모든 클래스 파일은 각각 하나의 클래스 또는 인터페이스를 정의한다.
- 클래스 파일은 바이트를 하나의 단위로 하는 이진 스트림 집합체다.

### 6.3.1 매직 넘버와 클래스 파일의 버전

- 모든 클래스 파일의 처음 4바이트는 매직 넘버로 시작한다.
- 매직 넘버는 가상 머신이 허용하는 클래스 파일인지 여부를 빠르게 확인하는 용도로만 쓰인다.
- 클래스 파일 뿐 아니라 다양한 파일 형식에서 파일 타입 식별용으로 매직 넘버를 즐겨 쓴다.
- 클래스 파일의 매직 넘버는 '낭만적인' 0xCAFEBABE 다.


- 매직 넘버 다음의 4바이트는 클래스 파일의 버전 번호다.
- 5~6번쨰 바이트는 마이너 버전을, 7~8번째 바이트는 메이저 버전을 뜻한다.

### 6.3.2 상수 풀

- 상수 풀은 클래스 파일의 자원 창고라 할 수 있다.
- 클래스 파일 형식 설계자가 0번 째 상수를 비워뒀다. 상수 풀 인덱스를 가리키는 데이터에서 '상수 풀 항목을 참조하지 않음'을 표현해야 하는 특수한 경우에 인덱스를 0으로 설정하도록 한 것이다.


- 자바에서 링크는 가상 머신이 클래스 파일을 로드할 때 동적으로 이루어진다.

### 6.3.3 접근 플래그

- 상수 풀 다음의 2바이트는 현재 클래스(또는 인터페이스)의 접근 정보를 식별하는 접근 플래그다.

### 6.3.4 클래스 인덱스, 부모 클래스 인덱스, 인터페이스 인덱스

- 클래스 파일의 상속 관계를 규정한다.
- 자바 언어는 다중 상속을 허용하지 않으므로 부모 클래스 인덱스는 하나뿐이다.
- java.lang.Object를 제외한 모든 자바 클래스의 부모 클래스 인덱스는 값이 0이 아니다.

### 6.3.5 필드 테이블

- 인터페이스나 클래스 안에 선언된 변수들을 설명하는 데 쓰인다.

> 자바 언어에서 필드가 어떤 정보를 담고 있는가?
> 1. 필드에 접근할 수 있는 범위 제한
> 2. 인스턴스 변수와 클래스 변수의 구분
> 3. 불변 여부
> 4. 휘발성(volatile, CPU 캐시가 아닌 메인 메모리를 직접 읽거나 쓰게 함)
> 5. 직렬화 시 포함 여부
> 6. 데이터 타입
> 7. 필드 이름

- 부모 클래스나 부모 인터페이스로부터 상속받은 필드는 필드 테이블 컬렉션에 나열하지 않는다.

> 소스 코드에는 존재하지 않는 필드가 등장하는 경우. ex 내부 클래스
> - 내부 클래스는 외부 클래스를 가리킬 수단이 필요하다. 이를 위해 컴파일러가 외부 클래스의 인스턴스를 가리키는 필드를 자동으로 추가한다.

- 클래스 파일 형식 차원에서는(자바 언어와 달리) 서술자만 다르면 이름이 같더라도 다른 필드로 취급한다.

### 6.3.6 메서드 테이블

- 클래스 파일에서 메서드 저장 형태는 필드 저장 형태와 거의 같다.
- 메서드 본문의 자바 코드는 javac 컴파일러에 의해 바이트코드 명령어로 변환된 후, 메서드 속성 테이블 컬렉션의 "Code" 속성에 따로 저장된다.

### 6.3.7 속성 테이블

- 클래스 파일, 필드 테이블, 메서드 테이블, Code 속성, 레코드 구성 요소는 모두 특정 시나리오에서 특정한 정보를 설명하기 위해 고유한 속성 테이블을 포함할 수 있다.
- 클래스 파일의 다른 데이터 항목들은 순서, 길이, 내용을 엄격하게 지켜야 하는데 반해 속성 테이블 컬렉션은 제약이 살짝 느슨하며 순서에도 엄격하지 않다.
