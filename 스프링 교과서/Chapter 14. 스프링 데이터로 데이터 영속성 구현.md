# Chapter 14. 스프링 데이터로 데이터 영속성 구현

## 14.1 스프링 데이터란

- 우리가 사용하는 영속성 기술에 맞는 구현을 제공하여 영속성 계층의 개발을 편리하게 해주는 스프링 생태계의 한 프로젝트이다.
- 자바 생태계는 다양하고 많은 영속성 기술을 제공한다. 각 기술은 특정 방식으로 사용되며 기술마다 고유한 추상화 및 클래스 설계가 있다.
- 앱의 영속성 기능을 구현하는 방법이 너무 많으면 복잡성은 증가한다.
- 앱의 영속성 계층을 구현할 때 JDBC가 관계형 DBMS에 연결하는 유일한 선택지는 아니다.

> 스프링 데이터는 다음 방법으로 영속성 계층 구현을 단순화한다.
> - 다양한 영속성 기술에 대한 공통적인 추상화(인터페이스) 집합을 제공한다. 이렇게 하면 서로 다른 기술에 대한 영속성을 구현할 때 유사한 방식을 취할 수 있다.
> - 스프링 데이터가 구현체를 제공하는 추상화만 사용하여 사용자가 영속성 연산 작업을 구현할 수 있게 한다. 이렇게 하면 코드를 더 적게 작성할 수 있으므로 앱 기능을 더 빠르게 구현할 수 있다.

## 14.2 스프링 데이터의 작동 방식

> 앱에서 사용되는 영속성 기술이 어떤 것이든 스프링 데이터는 앱 영속성 기능을 정의하기 위해 확장하는 공통된 인터페이스(계약) 집합을 제공한다.
> 아래는 인터페이스이다.
> - Repository: 가장 추상적인 계약. 이 계약을 확장하면 앱은 사용자가 작성한 인터페이스를 특정 스프링 데이터 레포지토리로 인식한다. 새 레코드 추가, 모든 레코드 조회, 기본 키로 레코드 가져오기 같은 어떤 사전 정의된 연산 작업도 상속되지 않는다. 이 인터페이스는 어떤 메서드도 선언하지 않는 **마커 인터페이스**이다.
> - CrudRepository: 일부 영속성 기능도 제공하는 가장 간단한 스프링 데이터 계약이다. 이 계약을 확장하여 앱 영속성 기능을 정의하면 레코드를 생성, 검색, 업데이트, 삭제하는 가장 간단한 연산 작업을 수행할 수 있다.
> - PagingAndSortingRepository: CrudRepository를 확장하여 레코드를 정렬하거나 특정 수(페이지) 단위로 조회하는 것과 관련된 연산 작업을 추가한다.

- 인터페이스 분리 원칙을 따라서 각각의 인터페이스들로 나누어진 것이다.
- JpaRepository 인터페이스는 PagingAndSortingRepository보다 더 구체적인 계약이다.
- 앱이 특정 기술을 사용할 때는 해당 기술에 특화된 연산을 제공하는 스프링 데이터 계약을 확장한다.
- 다양한 스프링 데이터 모듈은 보다 특정한 계약을 제공할 수 있다.

## 14.3 스프링 데이터 JDBC 사용

- 스프링 데이터는 몇 가지 명명 규칙에 따라 메서드 이름을 해석하고 사용자를 위해 백그라운드에서 SQL 쿼리를 생성한다.

> 항상 스프링 데이터에 의존하여 메서드 이름을 변환하지 않고 쿼리를 명시적으로 지정할 것을 권장한다.
> 그 이유는 다음과 같다.
> - 연산 작업에 더 복잡한 쿼리가 필요할 때는 메서드 이름이 너무 길어 읽기 어려울 수 있다.
> - 개발자가 실수로 메서드 이름을 리펙터링하면 자신도 모르게 앱 동작에 영향을 미칠 수 있다.(안타깝게도 모든 앱이 충분히 테스트되는 것은 아니므로 이 점을 고려해야 한다.)
> - 메서드 이름을 작성할 때 힌트를 제공하는 IDE가 없다면 스프링 데이터의 명명 규칙을 학습해야 한다.
> - 스프링 데이터도 메서드 이름을 쿼리로 변환해야 하기 때문에 앱 초기화가 느려져 성능에 영향을 미친다.(앱은 부팅될 때 메서드 이름을 쿼리로 변환한다.)

- @Query 어노테이션을 사용하여 앱이 실행할 SQL 쿼리를 지정할 수 있다.
- 메서드에 @Query 어노테이션을 달면 메서드 이름을 어떻게 지정하는지는 더 이상 중요하지 않다.
- 쿼리가 데이터를 변경하면 메서드에 @Modifying 어노테이션도 추가해야 한다.

## 14.4 요약

- 스프링 데이터는 스프링 앱의 영속성 계층을 보다 쉽게 구현할 수 있도로 도와주는 스프링 생태계 프로젝트 중 하나이다. 스프링 데이터는 여러 영속성 기술에 대한 추상화 계층을 제공하고 공통의 계약 집합을 제공하여 구현을 용이하게 한다.
- 스프링 데이터를 사용하면 다음과 같이 표준 스프링 데이터 계약을 확장하는 인터페이스를 사용하여 레포지토리를 구현한다.
  - Repository: 어떤 영속성 연산 작업도 제공하지 않는다. 마커 인터페이스.
  - CrudRepository: 간단한 생성, 읽기, 수정, 삭제 연산 작업을 제공한다.
  - PagingAndSortingRepository: CrudRepository를 확정하여 페이지네이션과 정렬을 위한 연산 작업을 추가한다.
- 스프링 데이터를 사용할 때는 앱에서 사용하는 영속성 기술에 따라 특정 모듈을 선택한다.
- 스프링 데이터 계약을 확장할 때 앱은 해당 계약에서 정의한 연산을 상속해서 사용할 수 있다. 하지만 앱에서는 사용자 정의 메서드를 사용하여 사용자가 정의한 연산을 정의할 수 있다.
- 스프링 데이터 레포지토리 메서드에 @Query 어노테이션을 사용하면 특정 연산 작업을 실행하는 SQL 쿼리를 정의할 수 있다.
- 메서드를 선언하고 @Query 어노테이션으로 쿼리를 명시적으로 지정하지 않으면 스프링 데이터는 메서드 이름을 SQL 쿼리로 변환한다. 메서드 이름을 스프링 데이터 명명 규칙에 따라 정의해야 올바른 쿼리로 변환할 수 있다. 스프링 데이터가 메서드 이름을 해석할 수 없다면 애플리케이션은 예외를 발생시키고 시작하지 못한다.
- 메서드 이름을 쿼리로 변환하는 스프링 데이터에 의존하지 말고 @Query 어노테이션을 사용하는 것이 좋다.
- 데이터를 변견하는 모든 연산에는 @Modifying 어노테이션을 추가하여 해당 연산 작업이 데이터 레코드를 변경한다는 것을 스프링 데이터에 알려야 한다.